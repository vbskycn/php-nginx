# 测试指南

## 概述

本项目提供了完整的测试套件，用于验证Docker镜像的功能和性能。测试包括基本功能测试、多配置测试和性能测试。

## 测试类型

### 1. 基本功能测试

使用Docker Compose进行基本功能测试：

```bash
# 设置环境变量
export IMAGE_NAME=zhoujie218/php-nginx
export IMAGE_TAG=latest

# 运行测试
docker compose -f docker-compose.test.yml up -d app
```

**测试内容**：
- 容器启动和健康检查
- 主页内容验证
- PHP-FPM状态检查
- 基本服务功能

### 2. 多配置测试

测试不同VPS配置的部署效果：

```bash
# Linux/macOS
./test-configs.sh

# Windows
test-configs.bat
```

**测试配置**：
- 1H512M：1核512MB
- 1H1G：1核1GB
- 1H2G：1核2GB
- 2H2G：2核2GB
- 2H4G：2核4GB

### 3. 手动测试

#### 基本功能测试

```bash
# 启动容器
docker run -d -p 8080:8080 --name test-php-nginx zhoujie218/php-nginx

# 等待启动
sleep 30

# 测试健康检查
curl -f http://localhost:8080/fpm-ping

# 测试主页
curl http://localhost:8080

# 测试PHP信息
curl http://localhost:8080/php.php

# 清理
docker stop test-php-nginx && docker rm test-php-nginx
```

#### 多配置测试

```bash
# 测试1H1G配置
docker run -d -p 8080:8080 -e VPS_CONFIG=1H1G --name test-1h1g zhoujie218/php-nginx

# 检查配置
docker exec test-1h1g php -i | grep memory_limit
docker exec test-1h1g redis-cli config get maxmemory

# 清理
docker stop test-1h1g && docker rm test-1h1g
```

## 测试配置说明

### docker-compose.test.yml

```yaml
services:
  app:
    image: ${IMAGE_NAME}:${IMAGE_TAG}
    build: .
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/fpm-ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  sut:
    image: alpine:3.21
    depends_on:
      app:
        condition: service_healthy
    volumes:
      - ./run_tests.sh:/run_tests.sh:ro
    command: sh /run_tests.sh
```

**关键特性**：
- 健康检查：确保应用完全启动后再进行测试
- 依赖管理：sut容器等待app容器健康后再启动
- 测试脚本：使用专门的测试脚本进行详细测试

### run_tests.sh

测试脚本包含以下检查：

1. **健康检查端点测试**
   ```bash
   curl --silent --fail http://app:8080/fpm-ping
   ```

2. **主页内容测试**
   ```bash
   curl --silent --fail http://app:8080 | grep -E '(PHP 8.4|nginx|php-nginx)'
   ```

3. **PHP-FPM状态测试**
   ```bash
   curl --silent --fail http://app:8080/fpm-status
   ```

## 故障排除

### 常见问题

#### 1. 容器启动失败

**症状**：容器无法启动或立即退出

**解决方案**：
```bash
# 查看容器日志
docker logs <容器名>

# 检查镜像是否存在
docker images | grep php-nginx

# 重新构建镜像
docker build -t zhoujie218/php-nginx:latest .
```

#### 2. 健康检查失败

**症状**：健康检查超时或失败

**解决方案**：
```bash
# 检查容器状态
docker ps -a

# 查看详细日志
docker logs <容器名>

# 手动测试健康检查
docker exec <容器名> curl -f http://localhost:8080/fpm-ping
```

#### 3. 测试超时

**症状**：测试脚本执行超时

**解决方案**：
```bash
# 增加等待时间
# 在run_tests.sh中增加sleep时间

# 检查网络连接
docker network ls
docker network inspect <网络名>
```

#### 4. 配置不生效

**症状**：环境变量配置没有生效

**解决方案**：
```bash
# 检查环境变量
docker exec <容器名> env | grep VPS_CONFIG

# 检查配置文件
docker exec <容器名> cat /etc/php84/conf.d/custom.ini
docker exec <容器名> cat /etc/redis.conf
```

### 调试方法

#### 1. 进入容器调试

```bash
# 进入运行中的容器
docker exec -it <容器名> sh

# 检查服务状态
ps aux | grep -E "(nginx|php-fpm|redis)"

# 检查配置文件
cat /etc/php84/conf.d/custom.ini
cat /etc/redis.conf
cat /etc/php84/php-fpm.d/www.conf
```

#### 2. 查看日志

```bash
# 查看容器日志
docker logs -f <容器名>

# 查看特定服务日志
docker exec <容器名> tail -f /var/log/nginx/error.log
```

#### 3. 网络测试

```bash
# 测试容器间网络
docker exec <容器名> ping app

# 测试端口连通性
docker exec <容器名> telnet app 8080
```

## 性能测试

### 负载测试

```bash
# 使用ab进行简单负载测试
docker run --rm --network host jordi/ab -n 1000 -c 10 http://localhost:8080/

# 使用wrk进行更详细的测试
docker run --rm --network host williamyeh/wrk -t12 -c400 -d30s http://localhost:8080/
```

### 内存使用测试

```bash
# 监控内存使用
docker stats <容器名>

# 检查PHP-FPM进程数
docker exec <容器名> ps aux | grep php-fpm | wc -l

# 检查Redis内存使用
docker exec <容器名> redis-cli info memory
```

## 持续集成

### GitHub Actions

项目配置了GitHub Actions工作流，自动运行测试：

```yaml
- name: Run tests
  run: |
    export IMAGE_NAME=zhoujie218/php-nginx
    export IMAGE_TAG=latest
    docker compose -f docker-compose.test.yml up -d app
```

### 本地CI

```bash
#!/bin/bash
# 本地CI脚本

set -e

echo "🧪 开始测试..."

# 构建镜像
docker build -t zhoujie218/php-nginx:test .

# 运行测试
export IMAGE_NAME=zhoujie218/php-nginx
export IMAGE_TAG=test
docker compose -f docker-compose.test.yml up --abort-on-container-exit

echo "✅ 测试完成"
```

## 测试最佳实践

1. **测试前准备**：
   - 确保Docker环境正常
   - 清理旧的测试容器
   - 检查网络连接

2. **测试执行**：
   - 使用健康检查确保服务完全启动
   - 添加适当的等待时间
   - 记录详细的测试日志

3. **测试后清理**：
   - 停止并删除测试容器
   - 清理测试网络
   - 保存测试结果

4. **持续改进**：
   - 定期更新测试用例
   - 添加新的功能测试
   - 优化测试性能

通过遵循这些测试指南，您可以确保Docker镜像的质量和可靠性。
