# æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼Œç”¨äºéªŒè¯Dockeré•œåƒçš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚æµ‹è¯•åŒ…æ‹¬åŸºæœ¬åŠŸèƒ½æµ‹è¯•ã€å¤šé…ç½®æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ã€‚

## æµ‹è¯•ç±»å‹

### 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•

ä½¿ç”¨Docker Composeè¿›è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•ï¼š

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export IMAGE_NAME=zhoujie218/php-nginx
export IMAGE_TAG=latest

# è¿è¡Œæµ‹è¯•
docker compose -f docker-compose.test.yml up -d app
```

**æµ‹è¯•å†…å®¹**ï¼š
- å®¹å™¨å¯åŠ¨å’Œå¥åº·æ£€æŸ¥
- ä¸»é¡µå†…å®¹éªŒè¯
- PHP-FPMçŠ¶æ€æ£€æŸ¥
- åŸºæœ¬æœåŠ¡åŠŸèƒ½

### 2. å¤šé…ç½®æµ‹è¯•

æµ‹è¯•ä¸åŒVPSé…ç½®çš„éƒ¨ç½²æ•ˆæœï¼š

```bash
# Linux/macOS
./test-configs.sh

# Windows
test-configs.bat
```

**æµ‹è¯•é…ç½®**ï¼š
- 1H512Mï¼š1æ ¸512MB
- 1H1Gï¼š1æ ¸1GB
- 1H2Gï¼š1æ ¸2GB
- 2H2Gï¼š2æ ¸2GB
- 2H4Gï¼š2æ ¸4GB

### 3. æ‰‹åŠ¨æµ‹è¯•

#### åŸºæœ¬åŠŸèƒ½æµ‹è¯•

```bash
# å¯åŠ¨å®¹å™¨
docker run -d -p 8080:8080 --name test-php-nginx zhoujie218/php-nginx

# ç­‰å¾…å¯åŠ¨
sleep 30

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl -f http://localhost:8080/fpm-ping

# æµ‹è¯•ä¸»é¡µ
curl http://localhost:8080

# æµ‹è¯•PHPä¿¡æ¯
curl http://localhost:8080/php.php

# æ¸…ç†
docker stop test-php-nginx && docker rm test-php-nginx
```

#### å¤šé…ç½®æµ‹è¯•

```bash
# æµ‹è¯•1H1Gé…ç½®
docker run -d -p 8080:8080 -e VPS_CONFIG=1H1G --name test-1h1g zhoujie218/php-nginx

# æ£€æŸ¥é…ç½®
docker exec test-1h1g php -i | grep memory_limit
docker exec test-1h1g redis-cli config get maxmemory

# æ¸…ç†
docker stop test-1h1g && docker rm test-1h1g
```

## æµ‹è¯•é…ç½®è¯´æ˜

### docker-compose.test.yml

```yaml
services:
  app:
    image: ${IMAGE_NAME}:${IMAGE_TAG}
    build: .
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/fpm-ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  sut:
    image: alpine:3.21
    depends_on:
      app:
        condition: service_healthy
    volumes:
      - ./run_tests.sh:/run_tests.sh:ro
    command: sh /run_tests.sh
```

**å…³é”®ç‰¹æ€§**ï¼š
- å¥åº·æ£€æŸ¥ï¼šç¡®ä¿åº”ç”¨å®Œå…¨å¯åŠ¨åå†è¿›è¡Œæµ‹è¯•
- ä¾èµ–ç®¡ç†ï¼šsutå®¹å™¨ç­‰å¾…appå®¹å™¨å¥åº·åå†å¯åŠ¨
- æµ‹è¯•è„šæœ¬ï¼šä½¿ç”¨ä¸“é—¨çš„æµ‹è¯•è„šæœ¬è¿›è¡Œè¯¦ç»†æµ‹è¯•

### run_tests.sh

æµ‹è¯•è„šæœ¬åŒ…å«ä»¥ä¸‹æ£€æŸ¥ï¼š

1. **å¥åº·æ£€æŸ¥ç«¯ç‚¹æµ‹è¯•**
   ```bash
   curl --silent --fail http://app:8080/fpm-ping
   ```

2. **ä¸»é¡µå†…å®¹æµ‹è¯•**
   ```bash
   curl --silent --fail http://app:8080 | grep -E '(PHP 8.4|nginx|php-nginx)'
   ```

3. **PHP-FPMçŠ¶æ€æµ‹è¯•**
   ```bash
   curl --silent --fail http://app:8080/fpm-status
   ```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**ï¼šå®¹å™¨æ— æ³•å¯åŠ¨æˆ–ç«‹å³é€€å‡º

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs <å®¹å™¨å>

# æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
docker images | grep php-nginx

# é‡æ–°æ„å»ºé•œåƒ
docker build -t zhoujie218/php-nginx:latest .
```

#### 2. å¥åº·æ£€æŸ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šå¥åº·æ£€æŸ¥è¶…æ—¶æˆ–å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs <å®¹å™¨å>

# æ‰‹åŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥
docker exec <å®¹å™¨å> curl -f http://localhost:8080/fpm-ping
```

#### 3. æµ‹è¯•è¶…æ—¶

**ç—‡çŠ¶**ï¼šæµ‹è¯•è„šæœ¬æ‰§è¡Œè¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¢åŠ ç­‰å¾…æ—¶é—´
# åœ¨run_tests.shä¸­å¢åŠ sleepæ—¶é—´

# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network ls
docker network inspect <ç½‘ç»œå>
```

#### 4. é…ç½®ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šç¯å¢ƒå˜é‡é…ç½®æ²¡æœ‰ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec <å®¹å™¨å> env | grep VPS_CONFIG

# æ£€æŸ¥é…ç½®æ–‡ä»¶
docker exec <å®¹å™¨å> cat /etc/php84/conf.d/custom.ini
docker exec <å®¹å™¨å> cat /etc/redis.conf
```

### è°ƒè¯•æ–¹æ³•

#### 1. è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨
docker exec -it <å®¹å™¨å> sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
ps aux | grep -E "(nginx|php-fpm|redis)"

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat /etc/php84/conf.d/custom.ini
cat /etc/redis.conf
cat /etc/php84/php-fpm.d/www.conf
```

#### 2. æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f <å®¹å™¨å>

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker exec <å®¹å™¨å> tail -f /var/log/nginx/error.log
```

#### 3. ç½‘ç»œæµ‹è¯•

```bash
# æµ‹è¯•å®¹å™¨é—´ç½‘ç»œ
docker exec <å®¹å™¨å> ping app

# æµ‹è¯•ç«¯å£è¿é€šæ€§
docker exec <å®¹å™¨å> telnet app 8080
```

## æ€§èƒ½æµ‹è¯•

### è´Ÿè½½æµ‹è¯•

```bash
# ä½¿ç”¨abè¿›è¡Œç®€å•è´Ÿè½½æµ‹è¯•
docker run --rm --network host jordi/ab -n 1000 -c 10 http://localhost:8080/

# ä½¿ç”¨wrkè¿›è¡Œæ›´è¯¦ç»†çš„æµ‹è¯•
docker run --rm --network host williamyeh/wrk -t12 -c400 -d30s http://localhost:8080/
```

### å†…å­˜ä½¿ç”¨æµ‹è¯•

```bash
# ç›‘æ§å†…å­˜ä½¿ç”¨
docker stats <å®¹å™¨å>

# æ£€æŸ¥PHP-FPMè¿›ç¨‹æ•°
docker exec <å®¹å™¨å> ps aux | grep php-fpm | wc -l

# æ£€æŸ¥Rediså†…å­˜ä½¿ç”¨
docker exec <å®¹å™¨å> redis-cli info memory
```

## æŒç»­é›†æˆ

### GitHub Actions

é¡¹ç›®é…ç½®äº†GitHub Actionså·¥ä½œæµï¼Œè‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼š

```yaml
- name: Run tests
  run: |
    export IMAGE_NAME=zhoujie218/php-nginx
    export IMAGE_TAG=latest
    docker compose -f docker-compose.test.yml up -d app
```

### æœ¬åœ°CI

```bash
#!/bin/bash
# æœ¬åœ°CIè„šæœ¬

set -e

echo "ğŸ§ª å¼€å§‹æµ‹è¯•..."

# æ„å»ºé•œåƒ
docker build -t zhoujie218/php-nginx:test .

# è¿è¡Œæµ‹è¯•
export IMAGE_NAME=zhoujie218/php-nginx
export IMAGE_TAG=test
docker compose -f docker-compose.test.yml up --abort-on-container-exit

echo "âœ… æµ‹è¯•å®Œæˆ"
```

## æµ‹è¯•æœ€ä½³å®è·µ

1. **æµ‹è¯•å‰å‡†å¤‡**ï¼š
   - ç¡®ä¿Dockerç¯å¢ƒæ­£å¸¸
   - æ¸…ç†æ—§çš„æµ‹è¯•å®¹å™¨
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

2. **æµ‹è¯•æ‰§è¡Œ**ï¼š
   - ä½¿ç”¨å¥åº·æ£€æŸ¥ç¡®ä¿æœåŠ¡å®Œå…¨å¯åŠ¨
   - æ·»åŠ é€‚å½“çš„ç­‰å¾…æ—¶é—´
   - è®°å½•è¯¦ç»†çš„æµ‹è¯•æ—¥å¿—

3. **æµ‹è¯•åæ¸…ç†**ï¼š
   - åœæ­¢å¹¶åˆ é™¤æµ‹è¯•å®¹å™¨
   - æ¸…ç†æµ‹è¯•ç½‘ç»œ
   - ä¿å­˜æµ‹è¯•ç»“æœ

4. **æŒç»­æ”¹è¿›**ï¼š
   - å®šæœŸæ›´æ–°æµ‹è¯•ç”¨ä¾‹
   - æ·»åŠ æ–°çš„åŠŸèƒ½æµ‹è¯•
   - ä¼˜åŒ–æµ‹è¯•æ€§èƒ½

é€šè¿‡éµå¾ªè¿™äº›æµ‹è¯•æŒ‡å—ï¼Œæ‚¨å¯ä»¥ç¡®ä¿Dockeré•œåƒçš„è´¨é‡å’Œå¯é æ€§ã€‚
