# 配置指南

## 概述

本项目支持多种VPS配置的自动优化，通过环境变量可以轻松适配不同的硬件配置，无需重新构建镜像。

## 支持的VPS配置

### 预设配置

| 配置名称 | CPU | 内存 | 适用场景 | PHP内存 | OPcache | Redis | PHP-FPM模式 |
|---------|-----|------|----------|---------|---------|-------|-------------|
| `1H512M` | 1核 | 512MB | 小型网站 | 64M | 32MB | 64mb | ondemand |
| `1H1G` | 1核 | 1GB | 中型网站 | 128M | 64MB | 128mb | dynamic |
| `1H2G` | 1核 | 2GB | 大型网站 | 256M | 128MB | 256mb | dynamic |
| `2H2G` | 2核 | 2GB | 高并发网站 | 256M | 128MB | 256mb | static |
| `2H4G` | 2核 | 4GB | 企业级应用 | 512M | 256MB | 512mb | static |

## 使用方法

### 方法1：使用预设配置（推荐）

```bash
# 1H512M配置（默认）
docker run -p 80:8080 -e VPS_CONFIG=1H512M zhoujie218/php-nginx

# 1H1G配置
docker run -p 80:8080 -e VPS_CONFIG=1H1G zhoujie218/php-nginx

# 1H2G配置
docker run -p 80:8080 -e VPS_CONFIG=1H2G zhoujie218/php-nginx

# 2H2G配置
docker run -p 80:8080 -e VPS_CONFIG=2H2G zhoujie218/php-nginx

# 2H4G配置
docker run -p 80:8080 -e VPS_CONFIG=2H4G zhoujie218/php-nginx
```

### 方法2：使用Docker Compose

```yaml
version: '3.8'
services:
  php-nginx:
    image: zhoujie218/php-nginx:latest
    ports:
      - "80:8080"
    environment:
      - VPS_CONFIG=2H4G  # 根据您的VPS配置选择
    volumes:
      - ./src:/var/www/html
    restart: unless-stopped
```

### 方法3：自定义配置

如果预设配置不满足需求，可以单独设置各个参数：

```bash
docker run -p 80:8080 \
  -e PHP_MEMORY_LIMIT=256M \
  -e OPCACHE_MEMORY=128 \
  -e REDIS_MAXMEMORY=256mb \
  -e PHP_FPM_MAX_CHILDREN=200 \
  zhoujie218/php-nginx
```

## 环境变量说明

### PHP配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `PHP_MEMORY_LIMIT` | 64M | PHP内存限制 |
| `OPCACHE_MEMORY` | 32 | OPcache内存大小(MB) |
| `OPCACHE_INTERNED_STRINGS` | 4 | OPcache字符串缓冲区(MB) |
| `OPCACHE_MAX_FILES` | 2000 | OPcache最大缓存文件数 |

### Redis配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `REDIS_MAXMEMORY` | 64mb | Redis最大内存使用量 |

### PHP-FPM配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `PHP_FPM_PM` | ondemand | 进程管理模式(static/dynamic/ondemand) |
| `PHP_FPM_MAX_CHILDREN` | 50 | 最大子进程数 |
| `PHP_FPM_START_SERVERS` | 2 | 启动时进程数 |
| `PHP_FPM_MIN_SPARE` | 1 | 最小空闲进程数 |
| `PHP_FPM_MAX_SPARE` | 10 | 最大空闲进程数 |
| `PHP_FPM_IDLE_TIMEOUT` | 10s | 空闲进程超时时间 |
| `PHP_FPM_MAX_REQUESTS` | 1000 | 每个进程最大请求数 |

## 配置选择建议

### 1H512M配置
- **适用场景**：个人博客、小型展示网站
- **特点**：内存使用最少，进程按需启动
- **推荐**：流量较小的静态网站

### 1H1G配置
- **适用场景**：中小型企业网站、内容管理系统
- **特点**：平衡性能和资源使用
- **推荐**：中等流量的动态网站

### 1H2G配置
- **适用场景**：大型内容网站、API服务
- **特点**：充足的缓存空间，支持更多并发
- **推荐**：高流量网站

### 2H2G配置
- **适用场景**：高并发应用、多用户系统
- **特点**：多核CPU优化，静态进程管理
- **推荐**：需要稳定性能的应用

### 2H4G配置
- **适用场景**：企业级应用、大型API服务
- **特点**：最大性能配置，支持大量并发
- **推荐**：高性能要求的应用

## 性能监控

### 查看当前配置

```bash
# 进入容器
docker exec -it <容器名> sh

# 查看PHP配置
php -i | grep -E "(memory_limit|opcache)"

# 查看Redis配置
redis-cli config get maxmemory

# 查看PHP-FPM状态
curl http://localhost:8080/fpm-status
```

### 监控资源使用

```bash
# 查看容器资源使用
docker stats <容器名>

# 查看PHP-FPM进程
docker exec <容器名> ps aux | grep php-fpm

# 查看Redis内存使用
docker exec <容器名> redis-cli info memory
```

## 故障排除

### 常见问题

1. **内存不足**
   - 症状：容器频繁重启，PHP Fatal error
   - 解决：降低VPS_CONFIG或增加内存限制

2. **进程数过多**
   - 症状：系统负载高，响应慢
   - 解决：减少PHP_FPM_MAX_CHILDREN

3. **Redis内存溢出**
   - 症状：Redis写入失败
   - 解决：增加REDIS_MAXMEMORY或优化缓存策略

### 调试方法

```bash
# 查看启动日志
docker logs <容器名>

# 查看配置生成日志
docker exec <容器名> cat /var/log/startup.log

# 测试配置
docker exec <容器名> php -m | grep opcache
docker exec <容器名> redis-cli ping
```

## 最佳实践

1. **选择合适的配置**：根据实际流量和硬件选择VPS_CONFIG
2. **监控资源使用**：定期检查内存和CPU使用情况
3. **渐进式优化**：从低配置开始，根据实际需求逐步调整
4. **备份配置**：记录有效的配置参数，便于后续部署
5. **测试验证**：在生产环境部署前，先在测试环境验证配置

## 升级指南

### 从固定配置升级

如果您之前使用的是固定配置的镜像，升级到新版本：

1. 停止旧容器
2. 拉取新镜像
3. 使用VPS_CONFIG环境变量启动新容器
4. 验证配置是否正确应用

```bash
# 停止旧容器
docker stop <旧容器名>

# 拉取新镜像
docker pull zhoujie218/php-nginx:latest

# 启动新容器
docker run -d -p 80:8080 \
  --name php-nginx-new \
  -e VPS_CONFIG=1H1G \
  -v /path/to/your/code:/var/www/html \
  zhoujie218/php-nginx:latest
```

这样就完成了从固定配置到动态配置的升级！
