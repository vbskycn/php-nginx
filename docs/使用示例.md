# 使用示例

## 基本使用场景

### 0. 不同规格机器配置示例

#### 1H512M (1核512M内存)
```bash
docker run -d \
  --name php-nginx \
  --restart=always \
  -p 80:8080 \
  -e PHP_MEMORY_LIMIT=64M \
  -e PHP_DISPLAY_ERRORS=Off \
  -e PHP_MAX_EXECUTION_TIME=30 \
  -e OPCACHE_ENABLE=1 \
  -e OPCACHE_MEMORY_CONSUMPTION=32 \
  -e PHP_FPM_PM_MODE=ondemand \
  -e PHP_FPM_MAX_CHILDREN=20 \
  -e REDIS_MAXMEMORY=64mb \
  -e NGINX_WORKER_PROCESSES=1 \
  -e NGINX_WORKER_CONNECTIONS=1024 \
  zhoujie218/php-nginx:latest
```

#### 1H1G (1核1G内存)
```bash
docker run -d \
  --name php-nginx \
  --restart=always \
  -p 80:8080 \
  -e PHP_MEMORY_LIMIT=128M \
  -e PHP_DISPLAY_ERRORS=Off \
  -e PHP_MAX_EXECUTION_TIME=30 \
  -e OPCACHE_ENABLE=1 \
  -e OPCACHE_MEMORY_CONSUMPTION=64 \
  -e PHP_FPM_PM_MODE=ondemand \
  -e PHP_FPM_MAX_CHILDREN=40 \
  -e REDIS_MAXMEMORY=128mb \
  -e NGINX_WORKER_PROCESSES=1 \
  -e NGINX_WORKER_CONNECTIONS=1024 \
  zhoujie218/php-nginx:latest
```

#### 1H2G (1核2G内存)
```bash
docker run -d \
  --name php-nginx \
  --restart=always \
  -p 80:8080 \
  -e PHP_MEMORY_LIMIT=256M \
  -e PHP_DISPLAY_ERRORS=Off \
  -e PHP_MAX_EXECUTION_TIME=30 \
  -e OPCACHE_ENABLE=1 \
  -e OPCACHE_MEMORY_CONSUMPTION=128 \
  -e OPCACHE_INTERNED_STRINGS_BUFFER=16 \
  -e PHP_FPM_PM_MODE=dynamic \
  -e PHP_FPM_MAX_CHILDREN=60 \
  -e PHP_FPM_START_SERVERS=12 \
  -e PHP_FPM_MIN_SPARE_SERVERS=6 \
  -e PHP_FPM_MAX_SPARE_SERVERS=24 \
  -e REDIS_MAXMEMORY=256mb \
  -e NGINX_WORKER_PROCESSES=1 \
  -e NGINX_WORKER_CONNECTIONS=1024 \
  zhoujie218/php-nginx:latest
```

#### 2H1G (2核1G内存)
```bash
docker run -d \
  --name php-nginx \
  --restart=always \
  -p 80:8080 \
  -e PHP_MEMORY_LIMIT=128M \
  -e PHP_DISPLAY_ERRORS=Off \
  -e PHP_MAX_EXECUTION_TIME=30 \
  -e OPCACHE_ENABLE=1 \
  -e OPCACHE_MEMORY_CONSUMPTION=64 \
  -e PHP_FPM_PM_MODE=dynamic \
  -e PHP_FPM_MAX_CHILDREN=40 \
  -e PHP_FPM_START_SERVERS=8 \
  -e PHP_FPM_MIN_SPARE_SERVERS=4 \
  -e PHP_FPM_MAX_SPARE_SERVERS=16 \
  -e REDIS_MAXMEMORY=128mb \
  -e NGINX_WORKER_PROCESSES=2 \
  -e NGINX_WORKER_CONNECTIONS=2048 \
  zhoujie218/php-nginx:latest
```

#### 2H2G (2核2G内存)
```bash
docker run -d \
  --name php-nginx \
  --restart=always \
  -p 80:8080 \
  -e PHP_MEMORY_LIMIT=256M \
  -e PHP_DISPLAY_ERRORS=Off \
  -e PHP_MAX_EXECUTION_TIME=30 \
  -e OPCACHE_ENABLE=1 \
  -e OPCACHE_MEMORY_CONSUMPTION=128 \
  -e OPCACHE_INTERNED_STRINGS_BUFFER=16 \
  -e PHP_FPM_PM_MODE=dynamic \
  -e PHP_FPM_MAX_CHILDREN=60 \
  -e PHP_FPM_START_SERVERS=12 \
  -e PHP_FPM_MIN_SPARE_SERVERS=6 \
  -e PHP_FPM_MAX_SPARE_SERVERS=24 \
  -e REDIS_MAXMEMORY=256mb \
  -e NGINX_WORKER_PROCESSES=2 \
  -e NGINX_WORKER_CONNECTIONS=2048 \
  zhoujie218/php-nginx:latest
```

#### 2H4G (2核4G内存)
```bash
docker run -d \
  --name php-nginx \
  --restart=always \
  -p 80:8080 \
  -e PHP_MEMORY_LIMIT=512M \
  -e PHP_DISPLAY_ERRORS=Off \
  -e PHP_MAX_EXECUTION_TIME=30 \
  -e OPCACHE_ENABLE=1 \
  -e OPCACHE_MEMORY_CONSUMPTION=256 \
  -e OPCACHE_INTERNED_STRINGS_BUFFER=32 \
  -e PHP_FPM_PM_MODE=static \
  -e PHP_FPM_MAX_CHILDREN=100 \
  -e PHP_FPM_START_SERVERS=20 \
  -e REDIS_MAXMEMORY=512mb \
  -e NGINX_WORKER_PROCESSES=2 \
  -e NGINX_WORKER_CONNECTIONS=2048 \
  zhoujie218/php-nginx:latest
```

#### 4H8G (4核8G内存)
```bash
docker run -d \
  --name php-nginx \
  --restart=always \
  -p 80:8080 \
  -e PHP_MEMORY_LIMIT=1024M \
  -e PHP_DISPLAY_ERRORS=Off \
  -e PHP_MAX_EXECUTION_TIME=30 \
  -e OPCACHE_ENABLE=1 \
  -e OPCACHE_MEMORY_CONSUMPTION=512 \
  -e OPCACHE_INTERNED_STRINGS_BUFFER=64 \
  -e PHP_FPM_PM_MODE=static \
  -e PHP_FPM_MAX_CHILDREN=200 \
  -e PHP_FPM_START_SERVERS=40 \
  -e REDIS_MAXMEMORY=1024mb \
  -e NGINX_WORKER_PROCESSES=4 \
  -e NGINX_WORKER_CONNECTIONS=4096 \
  zhoujie218/php-nginx:latest
```

#### 配置说明对比表

| 配置类型 | PHP内存 | CPU | 进程模式 | OPcache | Redis | 适用场景 |
|---------|---------|-----|----------|---------|-------|----------|
| 1H512M | 64M | 1核 | ondemand | 32MB | 64MB | 小型网站、测试环境 |
| 1H1G | 128M | 1核 | ondemand | 64MB | 128MB | 个人博客、小型应用 |
| 1H2G | 256M | 1核 | dynamic | 128MB | 256MB | 中型网站、API服务 |
| 2H1G | 128M | 2核 | dynamic | 64MB | 128MB | 开发环境、小型应用 |
| 2H2G | 256M | 2核 | dynamic | 128MB | 256MB | 企业网站、中型应用 |
| 2H4G | 512M | 2核 | static | 256MB | 512MB | 高并发网站、电商平台 |
| 4H8G | 1024M | 4核 | static | 512MB | 1024MB | 大型应用、高负载服务 |

#### 配置选择建议

**单核小内存 (1H512M-1H1G)**:
- 使用 `ondemand` 模式，按需创建进程
- 启用 OPcache 提升性能
- Nginx工作进程设为1

**单核大内存 (1H2G)**:
- 使用 `dynamic` 模式，平衡性能和内存
- 增加 OPcache 内存
- 保持Nginx工作进程为1

**双核配置 (2H1G-2H2G)**:
- 使用 `dynamic` 模式，充分利用CPU
- 启用 OPcache 和进程管理
- Nginx工作进程设为2

**高性能配置 (2H4G-4H8G)**:
- 使用 `static` 模式，最大化性能
- 最大化 OPcache 内存
- 增加进程数和连接数

### 1. 开发环境

#### 快速启动开发服务器
```bash
# 启动基础容器（使用默认配置）
docker run -d --name php-dev -p 8080:8080 zhoujie218/php-nginx

# 挂载开发代码
docker run -d --name php-dev -p 8080:8080 \
  -v $(pwd)/src:/var/www/html \
  zhoujie218/php-nginx

# 开发环境优化配置（推荐）
docker run -d --name php-dev -p 8080:8080 \
  -v $(pwd)/src:/var/www/html \
  -e PHP_MEMORY_LIMIT=256M \
  -e PHP_DISPLAY_ERRORS=On \
  -e PHP_MAX_EXECUTION_TIME=300 \
  -e OPCACHE_ENABLE=0 \
  -e PHP_FPM_PM_MODE=ondemand \
  -e PHP_FPM_MAX_CHILDREN=20 \
  -e REDIS_MAXMEMORY=64mb \
  zhoujie218/php-nginx
```

#### 使用Docker Compose开发
```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  php-nginx:
    image: zhoujie218/php-nginx:latest
    ports:
      - "8080:8080"
    volumes:
      - ./src:/var/www/html
    environment:
      - PHP_MEMORY_LIMIT=256M
      - PHP_DISPLAY_ERRORS=On
      - PHP_MAX_EXECUTION_TIME=300
      - OPCACHE_ENABLE=0
      - PHP_FPM_PM_MODE=ondemand
      - PHP_FPM_MAX_CHILDREN=20
      - REDIS_MAXMEMORY=64mb
    restart: unless-stopped
```

### 2. 生产环境

#### 生产环境配置
```yaml
# docker-compose.prod.yml
version: '3.8'
services:
  php-nginx:
    image: zhoujie218/php-nginx:latest
    ports:
      - "80:8080"
    volumes:
      - ./src:/var/www/html:ro
    environment:
      - PHP_MEMORY_LIMIT=128M
      - PHP_DISPLAY_ERRORS=Off
      - PHP_MAX_EXECUTION_TIME=30
      - OPCACHE_ENABLE=1
      - OPCACHE_MEMORY_CONSUMPTION=64
      - PHP_FPM_PM_MODE=dynamic
      - PHP_FPM_MAX_CHILDREN=80
      - PHP_FPM_START_SERVERS=8
      - PHP_FPM_MIN_SPARE_SERVERS=4
      - PHP_FPM_MAX_SPARE_SERVERS=16
      - REDIS_MAXMEMORY=128mb
      - NGINX_WORKER_PROCESSES=2
      - NGINX_WORKER_CONNECTIONS=2048
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/fpm-ping"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### 3. 负载均衡环境

#### 多实例部署
```yaml
# docker-compose.lb.yml
version: '3.8'
services:
  nginx-lb:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx-lb.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - php-nginx-1
      - php-nginx-2
      - php-nginx-3

  php-nginx-1:
    image: zhoujie218/php-nginx:latest
    expose:
      - "8080"
    volumes:
      - ./src:/var/www/html:ro

  php-nginx-2:
    image: zhoujie218/php-nginx:latest
    expose:
      - "8080"
    volumes:
      - ./src:/var/www/html:ro

  php-nginx-3:
    image: zhoujie218/php-nginx:latest
    expose:
      - "8080"
    volumes:
      - ./src:/var/www/html:ro
```

## 应用示例

### 1. Laravel应用

#### Dockerfile
```dockerfile
FROM zhoujie218/php-nginx:latest

# 安装Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# 复制应用代码
COPY . /var/www/html

# 安装依赖
RUN composer install --optimize-autoloader --no-dev

# 设置权限
RUN chown -R nobody:nobody /var/www/html/storage /var/www/html/bootstrap/cache
```

#### Nginx配置
```nginx
server {
    listen 8080;
    root /var/www/html/public;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

### 2. WordPress应用

#### 自定义配置
```bash
# 启动WordPress
docker run -d --name wordpress \
  -p 8080:8080 \
  -v $(pwd)/wordpress:/var/www/html \
  -e WORDPRESS_DB_HOST=db \
  -e WORDPRESS_DB_NAME=wordpress \
  -e WORDPRESS_DB_USER=wordpress \
  -e WORDPRESS_DB_PASSWORD=password \
  zhoujie218/php-nginx
```

#### PHP配置优化
```ini
; php.ini for WordPress
memory_limit = 256M
upload_max_filesize = 64M
post_max_size = 64M
max_execution_time = 300
max_input_vars = 3000
```

### 3. API服务

#### 简单的REST API
```php
<?php
// api.php
header('Content-Type: application/json');

$method = $_SERVER['REQUEST_METHOD'];
$path = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);

switch ($method) {
    case 'GET':
        if ($path === '/api/users') {
            echo json_encode(['users' => [1, 2, 3]]);
        }
        break;
    case 'POST':
        if ($path === '/api/users') {
            $data = json_decode(file_get_contents('php://input'), true);
            echo json_encode(['created' => $data]);
        }
        break;
}
?>
```

## 监控和日志

### 1. 日志收集

#### 使用ELK Stack
```yaml
# docker-compose.monitoring.yml
version: '3.8'
services:
  php-nginx:
    image: zhoujie218/php-nginx:latest
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "logging=elk"

  elasticsearch:
    image: elasticsearch:7.14.0
    environment:
      - discovery.type=single-node

  logstash:
    image: logstash:7.14.0
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf

  kibana:
    image: kibana:7.14.0
    ports:
      - "5601:5601"
```

### 2. 性能监控

#### 使用Prometheus
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'php-nginx'
    static_configs:
      - targets: ['php-nginx:8080']
    metrics_path: '/fpm-status'
    params:
      format: ['prometheus']
```

## 安全最佳实践

### 1. 网络安全

#### 使用反向代理
```nginx
# nginx-proxy.conf
upstream php_backend {
    server php-nginx-1:8080;
    server php-nginx-2:8080;
    server php-nginx-3:8080;
}

server {
    listen 443 ssl;
    server_name example.com;
    
    ssl_certificate /etc/ssl/certs/example.com.crt;
    ssl_certificate_key /etc/ssl/private/example.com.key;
    
    location / {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 2. 数据安全

#### Redis密码保护
```bash
# 启动带密码的Redis
docker run -d --name redis-secure \
  -e REDIS_PASSWORD=your_secure_password \
  redis:alpine redis-server --requirepass your_secure_password
```

#### 文件权限设置
```bash
# 设置安全的文件权限
chmod 755 /var/www/html
chmod 644 /var/www/html/*.php
chmod 600 /var/www/html/config/*.php
```

## 故障恢复

### 1. 数据备份

#### 自动备份脚本
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup"

# 备份应用代码
tar -czf $BACKUP_DIR/app_$DATE.tar.gz /var/www/html

# 备份Redis数据
docker exec redis redis-cli BGSAVE
cp /var/lib/redis/dump.rdb $BACKUP_DIR/redis_$DATE.rdb

# 清理旧备份（保留7天）
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
find $BACKUP_DIR -name "*.rdb" -mtime +7 -delete
```

### 2. 容器恢复

#### 健康检查脚本
```bash
#!/bin/bash
# health-check.sh
CONTAINER_NAME="php-nginx"

if ! docker ps | grep -q $CONTAINER_NAME; then
    echo "Container $CONTAINER_NAME is not running. Restarting..."
    docker start $CONTAINER_NAME
fi

# 检查服务健康状态
if ! curl -f http://localhost:8080/fpm-ping > /dev/null 2>&1; then
    echo "Service is not responding. Restarting container..."
    docker restart $CONTAINER_NAME
fi
```

## 性能优化示例

### 1. 缓存策略

#### Redis缓存实现
```php
<?php
// cache.php
class Cache {
    private $redis;
    
    public function __construct() {
        $this->redis = new Redis();
        $this->redis->connect('127.0.0.1', 6379);
    }
    
    public function get($key) {
        $data = $this->redis->get($key);
        return $data ? unserialize($data) : null;
    }
    
    public function set($key, $value, $ttl = 3600) {
        return $this->redis->setex($key, $ttl, serialize($value));
    }
    
    public function delete($key) {
        return $this->redis->del($key);
    }
}
?>
```

### 2. 静态资源优化

#### Nginx缓存配置
```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary Accept-Encoding;
    
    # 启用gzip压缩
    gzip_static on;
}
```
