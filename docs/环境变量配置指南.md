# 环境变量配置指南

## 概述

本项目支持通过环境变量自定义配置，适应不同设备规格的部署需求。如果不设置环境变量，将使用512M VPS的默认优化配置。

## 配置系统架构

### 启动流程
1. **配置阶段**: 容器启动时运行 `configure.sh` 脚本
2. **模板处理**: 使用 `envsubst` 将环境变量替换到配置模板中
3. **配置验证**: 验证生成的配置文件语法正确性
4. **服务启动**: 启动 Supervisord 管理所有服务
5. **自动重启**: 任何服务崩溃都会自动重启

### 配置模板
- `config/php.ini.template` - PHP配置模板
- `config/fpm-pool.conf.template` - PHP-FPM配置模板
- `config/nginx.conf.template` - Nginx配置模板
- `config/redis.conf.template` - Redis配置模板

### 默认值设置
所有环境变量都有合理的默认值，确保在不设置环境变量时也能正常运行。

## 配置参数详解

### PHP配置

| 变量名 | 默认值 | 说明 | 推荐值 |
|--------|--------|------|--------|
| `PHP_MEMORY_LIMIT` | 64M | PHP脚本执行时的内存限制 | 512M: 64M, 1G: 128M, 2G: 256M, 4G: 512M |
| `OPCACHE_MEMORY_CONSUMPTION` | 32 | OPcache共享内存大小(MB) | 512M: 32, 1G: 64, 2G: 128, 4G: 256 |
| `OPCACHE_INTERNED_STRINGS_BUFFER` | 4 | 内部字符串缓冲区大小(MB) | 通常为OPcache内存的1/8 |
| `OPCACHE_MAX_ACCELERATED_FILES` | 2000 | 最大可缓存的文件数量 | 根据项目文件数量调整 |
| `OPCACHE_REVALIDATE_FREQ` | 60 | 检查文件修改的时间间隔(秒) | 开发环境: 0, 生产环境: 60-300 |

### PHP-FPM配置

| 变量名 | 默认值 | 说明 | 推荐值 |
|--------|--------|------|--------|
| `PHP_FPM_MAX_CHILDREN` | 50 | 最大子进程数 | 512M: 50, 1G: 80, 2G: 120, 4G: 200 |
| `PHP_FPM_START_SERVERS` | 2 | 启动时的进程数 | 通常为max_children的1/10 |
| `PHP_FPM_MIN_SPARE_SERVERS` | 1 | 最小空闲进程数 | 通常为start_servers的1/2 |
| `PHP_FPM_MAX_SPARE_SERVERS` | 10 | 最大空闲进程数 | 通常为max_children的1/5 |
| `PHP_FPM_PROCESS_IDLE_TIMEOUT` | 10s | 空闲进程超时时间 | 10-30秒 |
| `PHP_FPM_MAX_REQUESTS` | 1000 | 每个进程处理的最大请求数 | 1000-5000 |

### Redis配置

| 变量名 | 默认值 | 说明 | 推荐值 |
|--------|--------|------|--------|
| `REDIS_MAXMEMORY` | 64mb | Redis最大内存使用量 | 512M: 64mb, 1G: 128mb, 2G: 256mb, 4G: 512mb |
| `REDIS_MAXMEMORY_POLICY` | allkeys-lru | 内存淘汰策略 | allkeys-lru, volatile-lru, allkeys-random |

### Nginx配置

| 变量名 | 默认值 | 说明 | 推荐值 |
|--------|--------|------|--------|
| `NGINX_WORKER_PROCESSES` | auto | 工作进程数 | 通常等于CPU核心数 |
| `NGINX_WORKER_CONNECTIONS` | 1024 | 每个工作进程的最大连接数 | 1024-4096 |

## 不同设备规格的推荐配置

### 512M VPS (默认配置)
```yaml
environment:
  - PHP_MEMORY_LIMIT=64M
  - OPCACHE_MEMORY_CONSUMPTION=32
  - PHP_FPM_MAX_CHILDREN=50
  - REDIS_MAXMEMORY=64mb
  - NGINX_WORKER_PROCESSES=auto
```

### 1G VPS
```yaml
environment:
  - PHP_MEMORY_LIMIT=128M
  - OPCACHE_MEMORY_CONSUMPTION=64
  - OPCACHE_INTERNED_STRINGS_BUFFER=8
  - PHP_FPM_MAX_CHILDREN=80
  - PHP_FPM_START_SERVERS=8
  - PHP_FPM_MIN_SPARE_SERVERS=4
  - PHP_FPM_MAX_SPARE_SERVERS=16
  - REDIS_MAXMEMORY=128mb
  - NGINX_WORKER_PROCESSES=2
  - NGINX_WORKER_CONNECTIONS=2048
```

### 2G VPS
```yaml
environment:
  - PHP_MEMORY_LIMIT=256M
  - OPCACHE_MEMORY_CONSUMPTION=128
  - OPCACHE_INTERNED_STRINGS_BUFFER=16
  - PHP_FPM_MAX_CHILDREN=120
  - PHP_FPM_START_SERVERS=12
  - PHP_FPM_MIN_SPARE_SERVERS=6
  - PHP_FPM_MAX_SPARE_SERVERS=24
  - REDIS_MAXMEMORY=256mb
  - NGINX_WORKER_PROCESSES=4
  - NGINX_WORKER_CONNECTIONS=2048
```

### 4G VPS
```yaml
environment:
  - PHP_MEMORY_LIMIT=512M
  - OPCACHE_MEMORY_CONSUMPTION=256
  - OPCACHE_INTERNED_STRINGS_BUFFER=32
  - PHP_FPM_MAX_CHILDREN=200
  - PHP_FPM_START_SERVERS=20
  - PHP_FPM_MIN_SPARE_SERVERS=10
  - PHP_FPM_MAX_SPARE_SERVERS=40
  - REDIS_MAXMEMORY=512mb
  - NGINX_WORKER_PROCESSES=4
  - NGINX_WORKER_CONNECTIONS=4096
```

## 性能调优建议

### 内存分配原则
1. **总内存分配**: PHP内存 + OPcache内存 + Redis内存 + 系统内存 ≤ 总内存的80%
2. **PHP内存**: 根据应用需求，通常为总内存的20-30%
3. **OPcache内存**: 根据代码量，通常为总内存的10-20%
4. **Redis内存**: 根据缓存需求，通常为总内存的10-20%

### 进程数计算
1. **PHP-FPM进程数**: 根据并发用户数和内存限制计算
   - 公式: `max_children = 可用内存 / 单个进程内存使用量`
   - 单个PHP进程通常使用8-16MB内存
2. **Nginx工作进程**: 通常等于CPU核心数

### 监控和调优
1. 使用 `docker stats` 监控容器资源使用
2. 通过 `/fpm-status` 监控PHP-FPM状态
3. 使用 `redis-cli info memory` 监控Redis内存使用
4. 根据实际使用情况调整配置参数

## 故障排除

### 常见问题

1. **内存不足错误**
   - 检查PHP_MEMORY_LIMIT设置
   - 监控实际内存使用情况
   - 适当减少进程数或内存分配

2. **进程数过多**
   - 检查PHP_FPM_MAX_CHILDREN设置
   - 监控并发连接数
   - 适当调整进程管理参数

3. **Redis内存溢出**
   - 检查REDIS_MAXMEMORY设置
   - 调整REDIS_MAXMEMORY_POLICY策略
   - 监控缓存命中率

4. **性能问题**
   - 检查OPcache配置
   - 监控PHP-FPM进程状态
   - 分析Nginx访问日志

### 调试命令

```bash
# 查看容器资源使用
docker stats <container_name>

# 进入容器调试
docker exec -it <container_name> sh

# 查看PHP配置
docker exec <container_name> php -i | grep memory_limit

# 查看PHP-FPM状态
curl http://localhost/fpm-status

# 查看Redis信息
docker exec <container_name> redis-cli info memory

# 查看Nginx配置
docker exec <container_name> nginx -t
```

## 最佳实践

1. **渐进式调优**: 从默认配置开始，根据实际使用情况逐步调整
2. **监控优先**: 部署前先建立监控体系，根据数据调整配置
3. **测试验证**: 在生产环境部署前，在测试环境验证配置效果
4. **文档记录**: 记录每次配置调整的原因和效果
5. **定期评估**: 定期评估配置效果，根据业务增长调整参数

## 配置系统优势

### 1. 灵活性
- 支持运行时配置，无需重新构建镜像
- 可以根据不同环境（开发、测试、生产）使用不同配置
- 支持动态调整，适应业务增长

### 2. 可维护性
- 配置集中管理，易于维护
- 模板化配置，减少错误
- 自动验证，确保配置正确性

### 3. 可扩展性
- 支持多设备规格部署
- 可以轻松添加新的配置参数
- 支持复杂的配置场景

### 4. 安全性
- 配置在容器启动时生成，避免敏感信息泄露
- 支持配置文件权限控制
- 自动验证配置语法，防止配置错误

## 故障排除

### 配置生成失败
```bash
# 检查环境变量设置
docker exec <container_name> env | grep -E "(PHP_|NGINX_|REDIS_)"

# 检查配置模板文件
docker exec <container_name> ls -la /etc/php84/conf.d/*.template

# 查看配置生成日志
docker logs <container_name> | grep "配置"
```

### 服务启动失败
```bash
# 检查服务状态
docker exec <container_name> supervisorctl status

# 检查配置文件语法
docker exec <container_name> nginx -t
docker exec <container_name> php-fpm84 -t

# 查看服务日志
docker logs <container_name> | grep -E "(nginx|php-fpm|redis)"
```

### 性能问题
```bash
# 检查资源使用情况
docker stats <container_name>

# 检查PHP-FPM进程状态
curl http://localhost:8080/fpm-status

# 检查Redis内存使用
docker exec <container_name> redis-cli info memory
```
