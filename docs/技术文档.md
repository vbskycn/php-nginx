# 技术文档

## 概述

本项目基于 Alpine Linux 构建的轻量级 PHP-FPM 8.4 & Nginx 1.26 容器镜像，集成了 Redis 缓存服务。支持多种VPS配置的自动优化，通过环境变量可以轻松适配不同的硬件配置。

## 技术栈

- **基础镜像**: Alpine Linux 3.21
- **Web服务器**: Nginx 1.26
- **PHP运行时**: PHP 8.4-FPM
- **缓存服务**: Redis
- **进程管理**: Supervisord

## 架构特点

### 安全设计
- 使用非特权用户（nobody）运行所有服务
- 隐藏服务器标识头信息
- 禁用危险的Redis命令
- 文件权限严格控制

### 性能优化
- **多配置支持**：支持5种VPS配置预设，自动优化资源分配
- **智能进程管理**：根据硬件配置选择最佳PHP-FPM进程管理模式
- **内存优化**：针对不同内存大小优化PHP、Redis、OPcache配置
- **并发优化**：根据CPU和内存配置调整最大进程数和并发处理能力
- **缓存策略**：启用OPcache加速，Redis LRU淘汰策略
- **压缩支持**：Gzip压缩支持，静态资源缓存策略

## 配置说明

### 多配置系统

本项目实现了智能的多配置系统，支持通过环境变量自动适配不同的VPS配置：

**配置模板系统**：
- 使用配置模板文件（.template）支持环境变量替换
- 启动时根据VPS_CONFIG生成最终配置文件
- 支持预设配置和自定义配置两种模式

**预设配置**：
- `1H512M`：1核512MB，适合小型网站
- `1H1G`：1核1GB，适合中型网站
- `1H2G`：1核2GB，适合大型网站
- `2H2G`：2核2GB，适合高并发应用
- `2H4G`：2核4GB，适合企业级应用

### Nginx配置
- 监听8080端口（容器内）
- 支持PHP文件处理
- 静态资源5天缓存
- 健康检查端点（/fpm-ping, /fpm-status）
- 安全防护（拒绝访问隐藏文件）

### PHP-FPM配置
- Unix socket通信（/run/php-fpm.sock）
- 根据VPS配置自动调整最大进程数（20-200）
- 智能选择进程管理模式（ondemand/dynamic/static）
- 10秒空闲超时
- 1000请求后重启进程（防止内存泄漏）

### Redis配置
- 无持久化存储（适合缓存场景）
- 根据VPS配置自动调整内存限制（64MB-512MB）
- LRU淘汰策略
- 仅本地访问

## 扩展功能

### 添加 Composer 支持

如果您的项目中需要 [Composer](https://getcomposer.org/)，这里有一个简单的方法来添加它。

```Dockerfile
FROM vbskycn/php-nginx:latest

# 从官方镜像安装 composer
COPY --from=composer /usr/bin/composer /usr/bin/composer

# 运行 composer install 来安装依赖项
RUN composer install --optimize-autoloader --no-interaction --no-progress
```

#### 使用 Composer 构建

如果您正在构建一个包含源代码和由 composer 管理的依赖项的镜像，那么定义可以改进。

```Dockerfile
FROM composer AS composer

# 复制源代码目录并使用 composer 安装依赖项
COPY <your_directory>/ /app

# 运行 composer install 来安装依赖项
RUN composer install \
  --optimize-autoloader \
  --no-interaction \
  --no-progress

# 继续使用所需镜像进行阶段构建，并复制源代码，包括由 composer 下载的依赖项
FROM vbskycn/php-nginx:latest
COPY --chown=nobody --from=composer /app /var/www/html
```

### 添加 Xdebug 支持

创建以下文件 `xdebug.ini`

```ini
zend_extension=xdebug.so
xdebug.mode=develop,debug
xdebug.discover_client_host=true
xdebug.start_with_request=yes
xdebug.trigger_value=PHPSTORM
xdebug.log_level=0

xdebug.var_display_max_children=10
xdebug.var_display_max_data=10
xdebug.var_display_max_depth=10

xdebug.client_host=host.docker.internal
xdebug.client_port=9003
```

使用以下 `Dockerfile` 创建新镜像

```Dockerfile
FROM vbskycn/php-nginx:latest

# 临时切换到 root 用户
USER root

# 安装 xdebug
RUN apk add --no-cache php84-pecl-xdebug

# 添加配置
COPY xdebug.ini ${PHP_INI_DIR}/conf.d/xdebug.ini

# 切换回非 root 用户
USER nobody
```

### 添加 HTTPS/SSL 支持

> 以下所有说明应根据您的个人需求进行调整

如果您计划仅在本地工作，首先生成您的自签名证书和密钥：

```bash
openssl req -x509 -nodes -newkey rsa:2048 -keyout https.key -out https.crt -subj "/CN=localhost" -days 5000
```

然后在Dockerfile的构建阶段复制您的证书文件：

```Dockerfile
FROM vbskycn/php-nginx:latest

# ...

COPY https.crt /etc/nginx/ssl/default.crt
COPY https.key /etc/nginx/ssl/default.key

# ...

```

编辑您的 nginx.conf 文件。

```nginx
server {
    listen [::]:443 ssl;
    listen 443 ssl;
    server_name localhost;
    root /var/www/html/public;

    ssl_certificate /etc/nginx/ssl/default.crt;
    ssl_certificate_key /etc/nginx/ssl/default.key;

    # ... 其余配置在这里
}
```

如果您使用 docker-compose，这里有一个示例：

```yaml
  php-nginx:
    build: ./api
    networks: [ backend ]
    ports: [ "443:443" ]
    working_dir: /var/www/html
    volumes:
      - ./api:/var/www/html
      - ./api/nginx.conf:/etc/nginx/conf.d/default.conf
    restart: on-failure
```

### 获取负载均衡器后客户端的真实IP

如果您在代理或负载均衡器后面使用此容器，您可能希望获取客户端的真实IP而不是代理或负载均衡器的IP。

为此，您可以将以下配置添加到 [Nginx 配置](../config/nginx.conf)：

```nginx
set_real_ip_from <CIDR>

real_ip_header X-Forwarded-For;
real_ip_recursive on;
```

其中 `<CIDR>` 是您的代理或负载均衡器的CIDR，请参阅 [Nginx 文档](http://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from)。客户端的真实IP现在将在PHP中的 `$_SERVER['REMOTE_ADDR']` 下可用。

### 发送邮件

要能够在PHP中使用 `mail()` 函数，您需要在容器中安装MTA（邮件传输代理）。

最简单的方法是安装 `ssmtp`。

`ssmtp.conf` 文件需要基于[在线文档](https://wiki.archlinux.org/title/SSMTP)创建。

```Dockerfile
FROM vbskycn/php-nginx:latest

# 安装 ssmtp
RUN apk add --no-cache ssmtp

# 添加配置
COPY ssmtp.conf /etc/ssmtp/ssmtp.conf
```

## 性能调优

### 多配置优化

本项目支持多种VPS配置的自动优化，根据硬件配置自动调整参数：

**1H512M配置**：
- PHP内存限制：64MB
- OPcache内存：32MB
- Redis内存限制：64MB
- PHP-FPM最大进程数：20
- 支持20个并发用户

**1H1G配置**：
- PHP内存限制：128MB
- OPcache内存：64MB
- Redis内存限制：128MB
- PHP-FPM最大进程数：40
- 支持40个并发用户

**1H2G配置**：
- PHP内存限制：256MB
- OPcache内存：128MB
- Redis内存限制：256MB
- PHP-FPM最大进程数：60
- 支持60个并发用户

**2H2G配置**：
- PHP内存限制：256MB
- OPcache内存：128MB
- Redis内存限制：256MB
- PHP-FPM最大进程数：100
- 支持100个并发用户

**2H4G配置**：
- PHP内存限制：512MB
- OPcache内存：256MB
- Redis内存限制：512MB
- PHP-FPM最大进程数：200
- 支持200个并发用户

### 智能进程管理

**进程管理模式选择**：
- `ondemand`：按需创建进程，适合低并发场景
- `dynamic`：动态调整进程数，适合中等并发场景
- `static`：固定进程数，适合高并发场景

**进程数优化**：
- 基于实际使用场景调整最大进程数
- 避免进程过多导致的内存压力和上下文切换开销
- 提高单进程处理效率

### 缓存策略
- 静态资源缓存：5天
- OPcache启用，根据内存配置调整缓存大小
- Redis LRU淘汰策略，根据内存配置调整最大内存

## 监控和日志

### 健康检查
- 端点：`/fpm-ping`
- 状态：`/fpm-status`
- 超时：10秒

### 日志输出
- 所有服务日志重定向到容器输出
- 可通过 `docker logs -f <容器名称>` 查看
- 支持结构化日志格式

## 故障排除

### 常见问题

1. **容器无法启动**
   - 检查端口是否被占用：`netstat -tulpn | grep :8080`
   - 验证配置文件语法：`nginx -t`
   - 检查Docker资源限制

2. **PHP文件无法执行**
   - 检查文件权限：`ls -la /var/www/html/`
   - 验证PHP-FPM配置：`php-fpm84 -t`
   - 检查PHP错误日志

3. **静态文件无法访问**
   - 检查Nginx配置：`nginx -t`
   - 验证文件路径和权限
   - 检查MIME类型配置

4. **Redis连接失败**
   - 检查Redis服务状态：`redis-cli ping`
   - 验证Redis配置：`redis-server --test-memory 1`
   - 检查内存限制设置

5. **性能问题**
   - 监控内存使用：`docker stats`
   - 检查PHP-FPM进程数：`ps aux | grep php-fpm`
   - 分析Nginx访问日志

### 调试方法

```bash
# 查看容器日志
docker logs <容器名称>

# 进入容器调试
docker exec -it <容器名称> sh

# 检查服务状态
docker exec <容器名称> supervisorctl status

# 检查PHP配置
docker exec <容器名称> php -i

# 检查Redis状态
docker exec <容器名称> redis-cli info

# 检查Nginx配置
docker exec <容器名称> nginx -t

# 实时监控日志
docker logs -f <容器名称>
```

### 性能调优

#### 内存优化
```bash
# 调整PHP内存限制
echo "memory_limit = 128M" > /etc/php84/conf.d/memory.ini

# 调整Redis内存限制
echo "maxmemory 128mb" >> /etc/redis.conf
```

#### 并发优化
```bash
# 调整PHP-FPM进程数
echo "pm.max_children = 100" >> /etc/php84/php-fpm.d/www.conf

# 调整Nginx工作进程
echo "worker_processes 4;" >> /etc/nginx/nginx.conf
```

### 安全加固

#### 1. 禁用不必要的PHP函数
```ini
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source
```

#### 2. 配置安全头
```nginx
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
```

#### 3. 限制文件上传
```nginx
client_max_body_size 10M;
```

### 监控和日志

#### 1. 启用详细日志
```nginx
access_log /var/log/nginx/access.log main_timed;
error_log /var/log/nginx/error.log warn;
```

#### 2. 监控脚本
```bash
#!/bin/bash
# 监控脚本示例
while true; do
    echo "$(date): Memory: $(free -m | awk 'NR==2{printf "%.1f%%", $3*100/$2}')"
    echo "$(date): CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)"
    sleep 60
done
```
