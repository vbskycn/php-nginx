# 技术文档

## 概述

本项目基于 Alpine Linux 构建的轻量级 PHP-FPM 8.4 & Nginx 1.26 容器镜像，集成了 Redis 缓存服务。

## 技术栈

- **基础镜像**: Alpine Linux 3.21
- **Web服务器**: Nginx 1.26
- **PHP运行时**: PHP 8.4-FPM
- **缓存服务**: Redis
- **进程管理**: Supervisord

## 架构特点

### 环境变量配置系统
- **动态配置**: 支持通过环境变量在运行时配置所有关键参数
- **模板化**: 使用配置模板和环境变量替换机制
- **自动验证**: 配置生成后自动验证语法正确性
- **多设备支持**: 从512M VPS到4G+服务器的完整配置方案

### 启动流程
1. **配置生成**: 容器启动时运行 `configure.sh` 脚本
2. **模板处理**: 使用 `envsubst` 将环境变量替换到配置模板
3. **配置验证**: 验证生成的配置文件语法
4. **服务管理**: 启动 Supervisord 管理所有服务
5. **故障恢复**: 任何服务崩溃都会自动重启

### 安全设计
- 使用非特权用户（nobody）运行所有服务
- 隐藏服务器标识头信息
- 禁用危险的Redis命令
- 文件权限严格控制
- 配置在容器启动时生成，避免敏感信息泄露

### 性能优化
- PHP-FPM使用`ondemand`进程管理器，按需创建进程
- 针对512MB VPS优化的内存配置，支持扩展到更大规格
- 启用OPcache加速
- Gzip压缩支持
- 静态资源缓存策略
- 自动服务管理和故障恢复

## 配置说明

### 环境变量配置
所有配置都支持通过环境变量自定义，包括：
- **PHP配置**: 内存限制、OPcache设置等
- **PHP-FPM配置**: 进程管理、并发控制等
- **Nginx配置**: 工作进程数、连接数等
- **Redis配置**: 内存限制、淘汰策略等

### Nginx配置
- 监听8080端口（容器内）
- 支持PHP文件处理
- 静态资源5天缓存
- 健康检查端点（/fpm-ping, /fpm-status）
- 安全防护（拒绝访问隐藏文件）
- 支持环境变量配置工作进程数和连接数

### PHP-FPM配置
- Unix socket通信（/run/php-fpm.sock）
- 支持环境变量配置进程管理参数
- 默认最大50个并发进程（可配置）
- 10秒空闲超时（可配置）
- 1000请求后重启进程（可配置，防止内存泄漏）

### Redis配置
- 无持久化存储（适合缓存场景）
- 支持环境变量配置内存限制
- 默认64MB内存限制（可配置）
- LRU淘汰策略（可配置）
- 仅本地访问

## 扩展功能

### 添加 Composer 支持

如果您的项目中需要 [Composer](https://getcomposer.org/)，这里有一个简单的方法来添加它。

```Dockerfile
FROM zhoujie218/php-nginx:latest

# 从官方镜像安装 composer
COPY --from=composer /usr/bin/composer /usr/bin/composer

# 运行 composer install 来安装依赖项
RUN composer install --optimize-autoloader --no-interaction --no-progress
```

#### 使用 Composer 构建

如果您正在构建一个包含源代码和由 composer 管理的依赖项的镜像，那么定义可以改进。

```Dockerfile
FROM composer AS composer

# 复制源代码目录并使用 composer 安装依赖项
COPY <your_directory>/ /app

# 运行 composer install 来安装依赖项
RUN composer install \
  --optimize-autoloader \
  --no-interaction \
  --no-progress

# 继续使用所需镜像进行阶段构建，并复制源代码，包括由 composer 下载的依赖项
FROM zhoujie218/php-nginx:latest
COPY --chown=nobody --from=composer /app /var/www/html
```

### 添加 Xdebug 支持

创建以下文件 `xdebug.ini`

```ini
zend_extension=xdebug.so
xdebug.mode=develop,debug
xdebug.discover_client_host=true
xdebug.start_with_request=yes
xdebug.trigger_value=PHPSTORM
xdebug.log_level=0

xdebug.var_display_max_children=10
xdebug.var_display_max_data=10
xdebug.var_display_max_depth=10

xdebug.client_host=host.docker.internal
xdebug.client_port=9003
```

使用以下 `Dockerfile` 创建新镜像

```Dockerfile
FROM zhoujie218/php-nginx:latest

# 临时切换到 root 用户
USER root

# 安装 xdebug
RUN apk add --no-cache php84-pecl-xdebug

# 添加配置
COPY xdebug.ini ${PHP_INI_DIR}/conf.d/xdebug.ini

# 切换回非 root 用户
USER nobody
```

### 添加 HTTPS/SSL 支持

> 以下所有说明应根据您的个人需求进行调整

如果您计划仅在本地工作，首先生成您的自签名证书和密钥：

```bash
openssl req -x509 -nodes -newkey rsa:2048 -keyout https.key -out https.crt -subj "/CN=localhost" -days 5000
```

然后在Dockerfile的构建阶段复制您的证书文件：

```Dockerfile
FROM zhoujie218/php-nginx:latest

# ...

COPY https.crt /etc/nginx/ssl/default.crt
COPY https.key /etc/nginx/ssl/default.key

# ...

```

编辑您的 nginx.conf 文件。

```nginx
server {
    listen [::]:443 ssl;
    listen 443 ssl;
    server_name localhost;
    root /var/www/html/public;

    ssl_certificate /etc/nginx/ssl/default.crt;
    ssl_certificate_key /etc/nginx/ssl/default.key;

    # ... 其余配置在这里
}
```

如果您使用 docker-compose，这里有一个示例：

```yaml
  php-nginx:
    build: ./api
    networks: [ backend ]
    ports: [ "443:443" ]
    working_dir: /var/www/html
    volumes:
      - ./api:/var/www/html
      - ./api/nginx.conf:/etc/nginx/conf.d/default.conf
    restart: on-failure
```

### 获取负载均衡器后客户端的真实IP

如果您在代理或负载均衡器后面使用此容器，您可能希望获取客户端的真实IP而不是代理或负载均衡器的IP。

为此，您可以将以下配置添加到 [Nginx 配置](../config/nginx.conf)：

```nginx
set_real_ip_from <CIDR>

real_ip_header X-Forwarded-For;
real_ip_recursive on;
```

其中 `<CIDR>` 是您的代理或负载均衡器的CIDR，请参阅 [Nginx 文档](http://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from)。客户端的真实IP现在将在PHP中的 `$_SERVER['REMOTE_ADDR']` 下可用。

### 发送邮件

要能够在PHP中使用 `mail()` 函数，您需要在容器中安装MTA（邮件传输代理）。

最简单的方法是安装 `ssmtp`。

`ssmtp.conf` 文件需要基于[在线文档](https://wiki.archlinux.org/title/SSMTP)创建。

```Dockerfile
FROM zhoujie218/php-nginx:latest

# 安装 ssmtp
RUN apk add --no-cache ssmtp

# 添加配置
COPY ssmtp.conf /etc/ssmtp/ssmtp.conf
```

## 性能调优

### 内存优化
- PHP内存限制：64MB（可配置）
- OPcache内存：32MB（可配置）
- Redis内存限制：64MB（可配置）

### 并发优化
- PHP-FPM最大进程数：50（可配置）
- Nginx工作连接数：1024（可配置）
- 支持50个并发用户（默认配置）

### 缓存策略
- 静态资源缓存：5天
- OPcache启用
- Redis LRU淘汰策略

## 监控和日志

### 健康检查
- 端点：`/fpm-ping`
- 状态：`/fpm-status`
- 超时：10秒

### 日志输出
- 所有服务日志重定向到容器输出
- 可通过 `docker logs -f <容器名称>` 查看
- 支持结构化日志格式

## 故障排除

### 常见问题

1. **容器无法启动**
   - 检查端口是否被占用：`netstat -tulpn | grep :8080`
   - 验证配置文件语法：`nginx -t`
   - 检查Docker资源限制

2. **PHP文件无法执行**
   - 检查文件权限：`ls -la /var/www/html/`
   - 验证PHP-FPM配置：`php-fpm84 -t`
   - 检查PHP错误日志

3. **静态文件无法访问**
   - 检查Nginx配置：`nginx -t`
   - 验证文件路径和权限
   - 检查MIME类型配置

4. **Redis连接失败**
   - 检查Redis服务状态：`redis-cli ping`
   - 验证Redis配置：`redis-server --test-memory 1`
   - 检查内存限制设置

5. **性能问题**
   - 监控内存使用：`docker stats`
   - 检查PHP-FPM进程数：`ps aux | grep php-fpm`
   - 分析Nginx访问日志

### 调试方法

```bash
# 查看容器日志
docker logs <容器名称>

# 进入容器调试
docker exec -it <容器名称> sh

# 检查服务状态
docker exec <容器名称> supervisorctl status

# 检查PHP配置
docker exec <容器名称> php -i

# 检查Redis状态
docker exec <容器名称> redis-cli info

# 检查Nginx配置
docker exec <容器名称> nginx -t

# 实时监控日志
docker logs -f <容器名称>
```

### 性能调优

#### 内存优化
```bash
# 调整PHP内存限制
echo "memory_limit = 128M" > /etc/php84/conf.d/memory.ini

# 调整Redis内存限制
echo "maxmemory 128mb" >> /etc/redis.conf
```

#### 并发优化
```bash
# 调整PHP-FPM进程数（推荐使用环境变量）
docker run -e PHP_FPM_MAX_CHILDREN=100 zhoujie218/php-nginx:latest

# 调整Nginx工作进程（推荐使用环境变量）
docker run -e NGINX_WORKER_PROCESSES=4 zhoujie218/php-nginx:latest
```

### 安全加固

#### 1. 禁用不必要的PHP函数
```ini
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source
```

#### 2. 配置安全头
```nginx
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
```

#### 3. 限制文件上传
```nginx
client_max_body_size 10M;
```

### 监控和日志

#### 1. 启用详细日志
```nginx
access_log /var/log/nginx/access.log main_timed;
error_log /var/log/nginx/error.log warn;
```

#### 2. 监控脚本
```bash
#!/bin/bash
# 监控脚本示例
while true; do
    echo "$(date): Memory: $(free -m | awk 'NR==2{printf "%.1f%%", $3*100/$2}')"
    echo "$(date): CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)"
    sleep 60
done
```
