# 部署指南

## 工作流触发方式

### 1. 更新版本文件并推送到 main 分支
```bash
# 编辑 version 文件
echo "php-nginx:1.1.47" > version

# 提交并推送
git add version
git commit -m "Update version to 1.1.47"
git push origin main
```
**效果**：
- ✅ 运行测试
- ✅ 构建并推送 Docker 镜像（latest 和版本标签）
- ✅ 自动创建 GitHub Release

### 2. 手动触发
在 GitHub Actions 页面手动运行工作流，可选择：
- 推送到 Docker Hub
- 指定分支

## 版本文件格式

`version` 文件格式：
```
php-nginx:1.1.47
```

- **名称**: `php-nginx`
- **版本号**: `1.1.47`
- **分隔符**: 使用冒号 `:` 分隔名称和版本

## 镜像标签

- `zhoujie218/php-nginx:latest` - 最新版本
- `zhoujie218/php-nginx:1.1.47` - 版本标签（从version文件读取）

## 使用镜像

### 基本使用
```bash
# 拉取最新版本
docker pull zhoujie218/php-nginx:latest

# 拉取特定版本
docker pull zhoujie218/php-nginx:1.1.47

# 运行容器（使用默认配置）
docker run -p 80:8080 zhoujie218/php-nginx:latest
```

### 环境变量配置
```bash
# 1G内存服务器配置
docker run -p 80:8080 \
  -e PHP_MEMORY_LIMIT=128M \
  -e OPCACHE_MEMORY_CONSUMPTION=64 \
  -e PHP_FPM_MAX_CHILDREN=40 \
  -e REDIS_MAXMEMORY=128mb \
  -e NGINX_WORKER_PROCESSES=2 \
  zhoujie218/php-nginx:latest

# 2G内存服务器配置
docker run -p 80:8080 \
  -e PHP_MEMORY_LIMIT=256M \
  -e OPCACHE_MEMORY_CONSUMPTION=128 \
  -e PHP_FPM_MAX_CHILDREN=60 \
  -e REDIS_MAXMEMORY=256mb \
  -e NGINX_WORKER_PROCESSES=2 \
  zhoujie218/php-nginx:latest
```

### Docker Compose配置
```yaml
version: '3.8'
services:
  php-nginx:
    image: zhoujie218/php-nginx:latest
    ports:
      - "80:8080"
    volumes:
      - ./src:/var/www/html
    environment:
      - PHP_MEMORY_LIMIT=128M
      - OPCACHE_MEMORY_CONSUMPTION=64
      - PHP_FPM_MAX_CHILDREN=40
      - REDIS_MAXMEMORY=128mb
      - NGINX_WORKER_PROCESSES=2
    restart: unless-stopped
```

## 注意事项

- Pull Request 不会触发 Docker 构建和 Release 创建
- 只有推送到 main 分支才会执行发布操作
- 版本号会自动添加 `v` 前缀创建标签
- 环境变量配置在容器启动时生效，无需重新构建镜像
- 建议在生产环境使用特定版本标签，避免使用 `latest` 标签

## 本地测试

### 构建测试镜像
```bash
# 构建本地镜像
docker build -t php-nginx:test .

# 运行测试
docker compose -f docker-compose.test.yml up
```

### 验证功能
```bash
# 检查PHP信息
curl http://localhost:8080

# 检查静态文件
curl http://localhost:8080/test.html
```
