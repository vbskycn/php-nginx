# 多资源配置指南

本指南介绍如何使用PHP-Nginx容器的多资源配置功能，支持从1H512M到2H4G的不同VPS配置优化。

## 概述

PHP-Nginx容器现在支持动态配置生成，可以根据不同的资源配置自动优化PHP、Nginx、Redis等服务的参数。支持以下配置方式：

1. **环境变量配置** - 通过环境变量动态调整配置
2. **预设配置** - 使用预定义的资源配置模板
3. **配置文件挂载** - 挂载自定义配置文件（最高优先级）

## 支持的资源配置

| 配置 | CPU | 内存 | 适用场景 | 预设名称 |
|------|-----|------|----------|----------|
| 1H512M | 1核 | 512MB | 小型网站、测试环境 | `1h512m` |
| 1H1G | 1核 | 1GB | 中小型网站 | `1h1g` |
| 1H2G | 1核 | 2GB | 中型网站 | `1h2g` |
| 2H2G | 2核 | 2GB | 中大型网站 | `2h2g` |
| 2H4G | 2核 | 4GB | 大型网站、高并发 | `2h4g` |

## 快速开始

### 使用预设配置

最简单的使用方式是设置 `RESOURCE_PROFILE` 环境变量：

```bash
# 1H512M配置（默认）
docker run -p 80:8080 -e RESOURCE_PROFILE=1h512m zhoujie218/php-nginx

# 1H1G配置
docker run -p 80:8080 -e RESOURCE_PROFILE=1h1g zhoujie218/php-nginx

# 2H4G配置
docker run -p 80:8080 -e RESOURCE_PROFILE=2h4g zhoujie218/php-nginx
```

### 使用Docker Compose

```yaml
version: '3.8'
services:
  php-nginx:
    image: zhoujie218/php-nginx:latest
    ports:
      - "80:8080"
    volumes:
      - ./src:/var/www/html
    environment:
      - RESOURCE_PROFILE=1h1g
    restart: unless-stopped
```

## 环境变量配置

### 资源配置变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `RESOURCE_PROFILE` | `1h512m` | 资源配置预设 |
| `PHP_MEMORY_LIMIT` | `64M` | PHP内存限制 |
| `OPCACHE_MEMORY` | `32` | OPcache内存大小(MB) |
| `REDIS_MAXMEMORY` | `64mb` | Redis最大内存 |
| `FPM_MAX_CHILDREN` | `20` | PHP-FPM最大进程数 |
| `FPM_PM_MODE` | `ondemand` | 进程管理模式 |
| `NGINX_WORKER_PROCESSES` | `auto` | Nginx工作进程数 |

### PHP配置变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `PHP_TIMEZONE` | `UTC` | PHP时区 |
| `PHP_MAX_EXECUTION_TIME` | `30` | 最大执行时间(秒) |
| `PHP_POST_MAX_SIZE` | `8M` | POST最大大小 |
| `PHP_UPLOAD_MAX_FILESIZE` | `2M` | 上传文件最大大小 |

### OPcache配置变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `OPCACHE_ENABLE` | `1` | 启用OPcache |
| `OPCACHE_INTERNED_STRINGS_BUFFER` | `4` | 字符串缓冲区大小(MB) |
| `OPCACHE_MAX_ACCELERATED_FILES` | `2000` | 最大加速文件数 |

### PHP-FPM配置变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `FPM_START_SERVERS` | `2` | 启动时进程数 |
| `FPM_MIN_SPARE_SERVERS` | `1` | 最小空闲进程数 |
| `FPM_MAX_SPARE_SERVERS` | `10` | 最大空闲进程数 |
| `FPM_PROCESS_IDLE_TIMEOUT` | `10s` | 进程空闲超时 |

### Nginx配置变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `NGINX_WORKER_CONNECTIONS` | `1024` | 工作连接数 |
| `NGINX_KEEPALIVE_TIMEOUT` | `65` | Keep-Alive超时 |
| `NGINX_GZIP_COMP_LEVEL` | `6` | Gzip压缩级别 |

### Redis配置变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `REDIS_MAXMEMORY_POLICY` | `allkeys-lru` | 内存淘汰策略 |
| `REDIS_BIND` | `127.0.0.1` | 绑定地址 |
| `REDIS_PORT` | `6379` | 端口号 |

## 使用示例

### 示例1：自定义内存配置

```bash
docker run -p 80:8080 \
  -e PHP_MEMORY_LIMIT=256M \
  -e OPCACHE_MEMORY=128 \
  -e REDIS_MAXMEMORY=256mb \
  zhoujie218/php-nginx
```

### 示例2：高并发配置

```bash
docker run -p 80:8080 \
  -e FPM_PM_MODE=static \
  -e FPM_MAX_CHILDREN=50 \
  -e NGINX_WORKER_PROCESSES=2 \
  -e NGINX_WORKER_CONNECTIONS=2048 \
  zhoujie218/php-nginx
```

### 示例3：开发环境配置

```bash
docker run -p 80:8080 \
  -e PHP_DISPLAY_ERRORS=On \
  -e PHP_MAX_EXECUTION_TIME=300 \
  -e OPCACHE_ENABLE=0 \
  zhoujie218/php-nginx
```

## 配置文件挂载

如果需要完全自定义配置，可以挂载配置文件：

```bash
docker run -p 80:8080 \
  -v /path/to/php.ini:/etc/php84/conf.d/custom.ini \
  -v /path/to/nginx.conf:/etc/nginx/nginx.conf \
  -v /path/to/redis.conf:/etc/redis.conf \
  zhoujie218/php-nginx
```

## 配置优先级

配置的优先级从高到低为：

1. **挂载的配置文件** - 最高优先级
2. **环境变量** - 覆盖预设配置
3. **预设配置** - 基于RESOURCE_PROFILE
4. **默认配置** - 最低优先级

## 性能调优建议

### 1H512M配置
- 使用 `ondemand` 进程管理
- 限制并发连接数
- 启用OPcache但分配较少内存

### 1H1G配置
- 使用 `dynamic` 进程管理
- 增加OPcache内存
- 适当增加并发数

### 2H2G配置
- 使用 `static` 进程管理
- 固定Nginx工作进程数为2
- 充分利用多核CPU

### 2H4G配置
- 最大化内存分配
- 使用静态进程管理
- 优化缓存策略

## 监控和调试

### 健康检查

容器内置健康检查端点：

```bash
# PHP-FPM状态
curl http://localhost:8080/fpm-status

# PHP-FPM Ping
curl http://localhost:8080/fpm-ping
```

### 日志查看

```bash
# 查看容器日志
docker logs -f <container_name>

# 查看配置生成日志
docker exec <container_name> cat /var/log/config-generation.log
```

### 配置验证

```bash
# 验证PHP配置
docker exec <container_name> php -m

# 验证Nginx配置
docker exec <container_name> nginx -t

# 验证Redis配置
docker exec <container_name> redis-cli ping
```

## 故障排除

### 常见问题

1. **内存不足**
   - 减少PHP内存限制
   - 降低OPcache内存
   - 使用ondemand进程管理

2. **性能不佳**
   - 检查资源配置是否匹配
   - 启用OPcache
   - 调整进程管理模式

3. **配置不生效**
   - 检查环境变量拼写
   - 确认配置文件挂载路径
   - 查看配置生成日志

### 调试命令

```bash
# 查看当前配置
docker exec <container_name> env | grep -E "(PHP_|OPCACHE_|FPM_|NGINX_|REDIS_)"

# 查看生成的配置文件
docker exec <container_name> cat /etc/php84/conf.d/custom.ini
docker exec <container_name> cat /etc/nginx/nginx.conf
docker exec <container_name> cat /etc/redis.conf
```

## 最佳实践

1. **选择合适的资源配置** - 根据实际需求选择预设配置
2. **监控资源使用** - 定期检查内存和CPU使用情况
3. **渐进式调优** - 从默认配置开始，逐步调整
4. **备份配置** - 保存有效的配置参数
5. **测试验证** - 在生产环境前充分测试

## 更新日志

- **v1.0.0** - 初始版本，支持基础的多资源配置
- **v1.1.0** - 添加环境变量配置支持
- **v1.2.0** - 优化配置生成性能和错误处理
