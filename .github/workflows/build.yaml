name: Test & build Docker image

on:
  push:
    branches: [main]
    tags: ["v*", "[0-9]+.[0-9]+.[0-9]+*"]
  pull_request:
  # schedule:
  #   - cron: "0 2 * * 6"
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build (default: current branch)'
        required: false
        default: ''
        type: string
      push_to_dockerhub:
        description: 'Push to Docker Hub (default: false for manual runs)'
        required: false
        default: false
        type: boolean

env:
  IMAGE_NAME: zhoujie218/php-nginx
  IMAGE_TAG: ${{ github.sha }}
  DOCKER_BUILDKIT: 1
  BUILDX_NO_DEFAULT_ATTESTATIONS: 1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Display build info
        run: |
          echo "Build triggered by: ${{ github.event_name }}"
          echo "Current branch: $(git branch --show-current)"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Git ref: ${{ github.ref }}"
          echo "Is main branch push: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}"
          echo "Is tag push: ${{ contains(github.ref, 'refs/tags/') }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual build - Branch: ${{ github.event.inputs.branch || 'current' }}"
            echo "Push to Docker Hub: ${{ github.event.inputs.push_to_dockerhub }}"
          fi
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "âš ï¸  This is a Pull Request build - Docker push and Release creation will be skipped"
            echo "ğŸ’¡ To trigger Docker build and Release, push directly to main branch or create a version tag"
          fi

      - name: Extract version from tag
        if: contains(github.ref, 'refs/tags/')
        id: extract_version
        run: |
          # æå–ç‰ˆæœ¬å·ï¼Œæ”¯æŒ v1.0.0 å’Œ 1.0.0 æ ¼å¼
          VERSION=${GITHUB_REF#refs/tags/}
          # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "Tag name: ${GITHUB_REF#refs/tags/}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        run: |-
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: Smoke test image
        run: |-
          docker compose -f docker-compose.test.yml up -d app
          sleep 2
          docker compose -f docker-compose.test.yml run sut

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          format: "template"
          template: "@/contrib/sarif.tpl"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      - name: Login to Docker Hub
        if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || contains(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build multi-arch image and push latest tag
        if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true')
        run: |-
          echo "å¼€å§‹æ„å»ºå¤šæ¶æ„é•œåƒ - $(date)"
          docker buildx build \
            --cache-from=type=registry,ref=$IMAGE_NAME:buildcache \
            --cache-to=type=registry,ref=$IMAGE_NAME:buildcache,mode=max \
            --push \
            -t $IMAGE_NAME:latest \
            --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6 \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            .
          echo "æ„å»ºå®Œæˆ - $(date)"

      - name: Skip Docker build (not main branch push)
        if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/main')
        run: |
          echo "â­ï¸  Skipping Docker build and push"
          echo "Reason: This is not a main branch push"
          echo "To trigger Docker build:"
          echo "  1. Push directly to main branch, or"
          echo "  2. Create a version tag (e.g., v1.0.0), or"
          echo "  3. Use manual workflow dispatch with 'Push to Docker Hub' enabled"

      - name: Build multi-arch image and push release tag
        if: contains(github.ref, 'refs/tags/')
        run: |-
          echo "å¼€å§‹æ„å»ºç‰ˆæœ¬æ ‡ç­¾é•œåƒ - $(date)"
          docker buildx build \
            --cache-from=type=registry,ref=$IMAGE_NAME:buildcache \
            --cache-to=type=registry,ref=$IMAGE_NAME:buildcache,mode=max \
            --push \
            -t $IMAGE_NAME:${{ steps.extract_version.outputs.VERSION }} \
            -t $IMAGE_NAME:${{ steps.extract_version.outputs.TAG_NAME }} \
            --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6 \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            .
          echo "ç‰ˆæœ¬æ ‡ç­¾æ„å»ºå®Œæˆ - $(date)"

      - name: Create GitHub Release
        if: contains(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract_version.outputs.TAG_NAME }}
          release_name: Release ${{ steps.extract_version.outputs.TAG_NAME }}
          body: |
            ## Docker Image Release ${{ steps.extract_version.outputs.TAG_NAME }}
            
            ### é•œåƒæ ‡ç­¾
            - `${{ env.IMAGE_NAME }}:${{ steps.extract_version.outputs.VERSION }}`
            - `${{ env.IMAGE_NAME }}:${{ steps.extract_version.outputs.TAG_NAME }}`
            
            ### æ”¯æŒçš„æ¶æ„
            - linux/amd64
            - linux/arm64
            - linux/arm/v7
            - linux/arm/v6
            
            ### ä½¿ç”¨æ–¹æ³•
            ```bash
            # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
            docker pull ${{ env.IMAGE_NAME }}:${{ steps.extract_version.outputs.VERSION }}
            
            # è¿è¡Œå®¹å™¨
            docker run -p 80:8080 ${{ env.IMAGE_NAME }}:${{ steps.extract_version.outputs.VERSION }}
            ```
            
            ### å˜æ›´æ—¥å¿—
            è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}) äº†è§£è¯¦ç»†å˜æ›´ã€‚
          draft: false
          prerelease: false

      - name: Skip Release creation (not a tag push)
        if: github.event_name != 'push' || !contains(github.ref, 'refs/tags/')
        run: |
          echo "â­ï¸  Skipping GitHub Release creation"
          echo "Reason: This is not a tag push"
          echo "To create a Release:"
          echo "  1. Create and push a version tag: git tag v1.0.0 && git push origin v1.0.0"
          echo "  2. Or use format: git tag 1.0.0 && git push origin 1.0.0"
